# 微信公众号简结

* 参考链接

    * [微信公众平台开发文档](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)
    * [企业号开发者中心](https://qydev.weixin.qq.com/wiki/index.php?title=%E9%A6%96%E9%A1%B5)

* [微信公众号开发流程概述](#微信公众号开发流程概述)
* [微信公众号开发配置](#微信公众号开发配置)


---

## 微信公众号开发流程概述

1. 参考链接

    * [微信公众号开发流程及完整代码，效果图](https://blog.csdn.net/qq_35713752/article/details/105228281)
    * [微信公众号 开发流程](https://zhuanlan.zhihu.com/p/21337587)

2. 详解

    1. 前提配置
        * 注册微信公众号 - 注册开发者账号(微信开放平台) - 在开发者账号内绑定自己的微信公众号 - 申请测试公众号 - 认证公众号
        * 备案网站并且有服务器。
        * 微信公众平台 - 登录微信公众号 - 设置 - 公众号设置 - 功能设置 - 添加JS接口安全域名，
        * 微信公众平台 - 登录微信公众号 - 开发 - 基本配置 - 添加IP地址白名单（配置后才能获取 access_token ）

    2. 在微信公众号平台获取基本参数
        * token
        * test_token
        * appid
        * appsecret
        * mch_id //支付
        * test_appid
        * test_appsecret
        * server_notify
        * key

    3. 服务器基本参数
        * 签名
        * ACESS_TOKEN
        * 配置JSSDK
        * openid(oauth2.0)

    4. 其它注意事项
        * 开发出现问题时，可以通过接口调用的返回码，以及报警排查指引（在公众平台官网-开发者中心处可以设置接口报警
        * 获取 access_token --> 根据access_token 获取 jsapi_ticket --> 生成JS-SDK权限验证的签名
        * access_token在2小时内有效，过期需要重新获取，但1天内获取次数有限，开发者需自行存储
        * 公众平台接口调用仅支持80端口
        * 如你已有小程序，并且已开通小程序云开发，则可以使用 公众号环境共享 能力，在公众号中使用云开发。
        * [接口权限说明](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Explanation_of_interface_privileges.html)
        * [全局返回码说明](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Global_Return_Code.html)

    5. 服务类型

        公众号主要通过公众号消息会话和公众号内网页来为用户提供服务的

        1. 公众号消息会话
            * 群发消息：订阅号为每天1次，服务号为每月4次，向用户群发消息，包括文字消息、图文消息、图片、视频、语音等
            * 被动回复消息：用户给公众号发消息后，可以回复一个消息
            * 客服消息：用户给公众号发消息后的48小时内，公众号可以给用户发送不限数量的消息
            * 模板消息：对用户发送服务通知（如刷卡提醒、服务预约成功通知等）时，公众号可以用特定内容模板，主动向用户发送消息
        2. 公众号内网页
            * 网页授权获取用户基本信息
            * 微信JS-SDK:可以使用它在网页上录制和播放微信语音、监听微信分享、上传手机本地图片、拍照等许多能力

    6. 样例

        ```html
        <!DOCTYPE html>
        <html lang="en">
            <head>
                <title>弹窗</title>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
                <meta http-equiv="X-UA-Compatible" content="ie=edge">
                <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
                <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
                <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>

                <style type="text/css">
                    .toast {
                        padding: 10px 25px 10px 25px;
                        background: rgba(0, 0, 0, .5);
                        border-radius: 5px;
                        color: #ffffff;
                        text-align: center;
                        position: fixed;
                        left: 50%;
                        top: 40%;
                        transform: translate(-50%, -50%);
                        z-index: 100;
                    }
                </style>
            </head>
            <body>
                <div id="test">
                    <toast v-if='isShow' :message='isShowMsg'></toast>
                    <div class="container" @click="showToast">
                        点击显示 showToast
                    </div>
                </div>
                <script>
                    var that;
                    Vue.component('toast', {
                        props: ['message'],
                        template: `
                        <div class="toast_bg_transparent">
                            <div class="toast">
                                <span>{{message}}</span>
                            </div>
                        </div>
                        `
                    })
                    new Vue({
                        el: '#test',
                        data() {
                            return {
                                isShow: false,
                                isShowMsg: '', //弹窗提示
                            }
                        },
                        methods: {
                            getA() {
                                var url = 'https://jayjing.wang/gongzhonghao_H5/getConfig.php';
                                $.ajax({
                                    url: url,
                                    complete: res => {
                                        var config = JSON.parse(res.responseText)
                                        console.log('res-config', config)
                                        wx.config({
                                            debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                                            appId: config.appId, // 必填，公众号的唯一标识
                                            timestamp: config.timestamp, // 必填，生成签名的时间戳
                                            nonceStr: config.nonceStr, // 必填，生成签名的随机串
                                            signature: config.signature, // 必填，签名
                                            jsApiList: [] // 必填，需要使用的JS接口列表
                                        });
                                    }
                                })
                            },
                            showToast() {
                                console.log('点击了 showToast')
                                this.isShow = true;
                                this.isShowMsg = '错误提示';

                                setTimeout(() => {
                                    this.isShow = false;
                                }, 1000);
                            }
                        },
                        mounted() {
                            this.getA()
                            wx.ready(function(res) {
                                console.log('ready', res)
                                // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
                            });
                        }
                    })
                </script>
            </body>
        </html>
        ```

        ```php
        <?php
            header("Content-Type:text/html;charset=utf8"); 
            header("Access-Control-Allow-Origin: *"); //解决跨域
            header('Access-Control-Allow-Methods:GET');// 响应类型  
            header('Access-Control-Allow-Headers:*'); // 响应头设置 
            $appid = "wx9025b8efd---";
            $secret = "3c242548fb56---";
                $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={$appid}&secret={$secret}";
                $s = file_get_contents($url);
                $s = json_decode($s, true);
                $url_b = "https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token={$s['access_token']}&type=jsapi";
                $data = file_get_contents($url_b);
                $data = json_decode($data, true);
                $ticket = $data['ticket'];
                //print();
                //echo $ticket;

                // 进行sha1签名
                $timestamp = time();
                $nonceStr = createNonceStr();
                // 注意 URL 建议动态获取(也可以写死).
                $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
                $url = "$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"; // 调用JSSDK的页面地址
                //$url = $_SERVER['HTTP_REFERER']; // 前后端分离的, 获取请求地址(此值不准确时可以通过其他方式解决)
                $str = "jsapi_ticket={$ticket}&noncestr={$nonceStr}&timestamp={$timestamp}&url={$url}";
                $sha_str = sha1($str);
                $signPackage = array(
                    "appId" =>  $appid,
                    "nonceStr" => $nonceStr,
                    "timestamp" => $timestamp,
                    "signature" => $sha_str,
                );
                //echo $appid.'-----'.$nonceStr.'-----'.$timestamp.'-----'.$sha_str;
            echo urldecode(json_encode($signPackage));

            //随机字符串
            function createNonceStr($length = 16) {
                $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                $str = "";
                for ($i = 0; $i < $length; $i++) {
                    $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);
                }
                return $str;
            }
            ?>
        ```

## 微信公众号开发配置

* 接入微信公众平台开发

    1. 填写服务器配置

        开发-基本设置-成为开发者-修改配置-填写：

        * 开发者用来接收微信消息和事件的接口URL
        * Token可由开发者可以任意填写，用作生成签名
        * EncodingAESKey由开发者手动填写或随机生成，将用作消息体加解密密钥
        * 可选择消息加解密方式：明文模式、兼容模式和安全模式

    2. 验证消息的确来自微信服务器

        开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上

        [校验代码](https://res.wx.qq.com/op_res/-serEQ6xSDVIjfoOHcX78T1JAYX-pM_fghzfiNYoD8uHVd3fOeC0PC_pvlg4-kmP)

    3. 依据接口文档实现业务逻辑

* 公众平台接口域名

    开发者可以根据自己的服务器部署情况，选择最佳的接入域名（延时更低，稳定性更高）。除此之外，可以将其他接入域名用作容灾用途。

    * 通用域名(api.weixin.qq.com)，使用该域名将访问官方指定就近的接入点；
    * 通用异地容灾域名(api2.weixin.qq.com)，当上述域名不可访问时可改访问此域名；
    * 上海域名(sh.api.weixin.qq.com)，使用该域名将访问上海的接入点；
    * 深圳域名(sz.api.weixin.qq.com)，使用该域名将访问深圳的接入点；
    * 香港域名(hk.api.weixin.qq.com)，使用该域名将访问香港的接入点。

* Access token

    access_token是公众号的全局唯一接口调用凭据，至少要保留512个字符空间，有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效

    公众号和小程序均可以使用AppID和AppSecret调用本接口来获取access_token

    * 调用：

        https请求方式: GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET

    * 说明：

        * 建议公众号开发者使用中控服务器统一获取和刷新access_token，不应该各自去刷新；

        * 中控服务器需要在2h提前去刷新新access_token，在刷新过程中，中控服务器可对外继续输出的老access_token，此时公众平台后台会保证在5分钟内，新老access_token都可用，这保证了第三方业务的平滑过渡；

        * access_token的有效时间可能会在未来有调整，所以中控服务器不仅需要内部定时主动刷新，还需要提供被动刷新access_token的接口，这样便于业务服务器在API调用获知access_token已超时的情况下，可以触发access_token的刷新流程

        * 对于可能存在风险的调用，需要用户管理员确认后才可以成功获取：

            * 开发者通过某IP发起调用->平台返回错误码[89503]并同时下发模板消息给公众号管理员->公众号管理员确认该IP可以调用->开发者使用该IP再次发起调用->调用成功
            * 如公众号管理员第一次拒绝该IP调用，用户在1个小时内将无法使用该IP再次发起调用
            * 公众号管理员多次拒绝该IP调用，该IP将可能长期无法发起调用
            * 建议开发者在发起调用前主动与管理员沟通确认调用需求，或请求管理员开启IP白名单功能并将该IP加入IP白名单列表

* 接口报警

    当微信服务器向开发者推送消息失败次数达到预定阈值时，会将报警消息发送到指定微信报警群中

    设置方式：公众平台->开发-运维中心->接口报警

    * 通用报警：
        * DNS失败

            * 填写的url,域名是否有误；
            
                * ping ip/域名

            * 域名是否发生变化，如过期，更新

        * DNS超时5秒

            * 目前不会有此错误

        * 连接超时5秒

            * 连接的IP是否有误

                * 获取到微信回调服务器的IP，https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=ACCESS_TOKEN
                * ping ip

            * 连接的IP是否过载，连接过多

                * 查看接入层服务器连接数，负载，nginx的配置，允许的连接个数
                * 查看nginx错误日志是否有“Connection reset by peer”或“Connection timed out”错误日志，如有说明nginx连接数过超负载。

                    一些重要配置参考例子
                    ```conf
                    worker_processes  16;          //CPU核数
                    error_log  logs/error.log  info;   //错误日志log
                    worker_rlimit_nofile 102400;     //打开最大句柄数
                    events {
                        worker_connections  102400;   //允许最大连接数
                    }
                    //请求日志记录，关键字段：request_time-请求总时间，upstream_response_time后端处理时 间
                    log_format  main  '$remote_addr  - $remote_user [$time_local] "$request" '
                                    '$status $body_bytes_sent "$http_referer" '
                                    '"$http_user_agent" "$http_x_forwarded_for" "$host"  "$cookie_ssl_edition" '
                                    '"$upstream_addr"   "$upstream_status"  "$request_time"  '
                                    '"$upstream_response_time" ';
                    access_log  logs/access.log  main;
                    ```

            * 托管商是否有故障
            * 网络运营商是否有故障
            * 是否设置了防火墙
            * 是否网络不通

        * 请求超时5秒

            * 连接的IP是否有误
            * 连接的IP是否接收到报警消息给出的该消息类型的请求
            * 请求是否处理时间过长
                * 机器负载太高，耗时增加
                    * 优化性能，扩容。
                    * 异步处理。
                * 机器处理异常，消息丢失
                

        * 回应不合法

            * 连接的IP是否有误
            * 连接的IP是否发生网络错误
            * 业务处理逻辑是否没有按照wiki规范回复消息，或是进入了异常逻辑

        * MarkFail（自动屏蔽，一分钟后解除屏蔽）

            此报警是级别最高的报警，开发者在收到此报警前，必然会收到连接超时，请求超时或回应失败等报警

    * 公众号第三方平台报警(公众号第三方平台的开发者，才需要关注)：
        * 推送component_verify_ticket超时5秒
        * 推送component_verify_ticket失败
        * 推送第三方平台消息超时5秒
        * 推送第三方平台消息失败

* 获取微信服务器IP地址

    1. 获取微信API接口 IP地址

        http请求方式: GET https://api.weixin.qq.com/cgi-bin/get_api_domain_ip?access_token=ACCESS_TOKEN

    2. 获取微信callback IP地址

        http请求方式: GET https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=ACCESS_TOKEN

    3. 网络检测

        HTTP Post请求： https://api.weixin.qq.com/cgi-bin/callback/check?access_token=ACCESS_TOKEN