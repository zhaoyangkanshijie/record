# 微信公众号简结

* 参考链接

    * [微信公众平台开发文档](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)
    * [企业号开发者中心](https://qydev.weixin.qq.com/wiki/index.php?title=%E9%A6%96%E9%A1%B5)

* [微信公众号开发流程概述](#微信公众号开发流程概述)
* [微信公众号开发配置](#微信公众号开发配置)
* [菜单配置](#菜单配置)
* [基础消息](#基础消息)

---

## 微信公众号开发流程概述

1. 参考链接

    * [微信公众号开发流程及完整代码，效果图](https://blog.csdn.net/qq_35713752/article/details/105228281)
    * [微信公众号 开发流程](https://zhuanlan.zhihu.com/p/21337587)

2. 详解

    1. 前提配置
        * 注册微信公众号 - 注册开发者账号(微信开放平台) - 在开发者账号内绑定自己的微信公众号 - 申请测试公众号 - 认证公众号
        * 备案网站并且有服务器。
        * 微信公众平台 - 登录微信公众号 - 设置 - 公众号设置 - 功能设置 - 添加JS接口安全域名，
        * 微信公众平台 - 登录微信公众号 - 开发 - 基本配置 - 添加IP地址白名单（配置后才能获取 access_token ）

    2. 在微信公众号平台获取基本参数
        * token
        * test_token
        * appid
        * appsecret
        * mch_id //支付
        * test_appid
        * test_appsecret
        * server_notify
        * key

    3. 服务器基本参数
        * 签名
        * ACESS_TOKEN
        * 配置JSSDK
        * openid(oauth2.0)

    4. 其它注意事项
        * 开发出现问题时，可以通过接口调用的返回码，以及报警排查指引（在公众平台官网-开发者中心处可以设置接口报警
        * 获取 access_token --> 根据access_token 获取 jsapi_ticket --> 生成JS-SDK权限验证的签名
        * access_token在2小时内有效，过期需要重新获取，但1天内获取次数有限，开发者需自行存储
        * 公众平台接口调用仅支持80端口
        * 如你已有小程序，并且已开通小程序云开发，则可以使用 公众号环境共享 能力，在公众号中使用云开发。
        * [接口权限说明](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Explanation_of_interface_privileges.html)
        * [全局返回码说明](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Global_Return_Code.html)

    5. 服务类型

        公众号主要通过公众号消息会话和公众号内网页来为用户提供服务的

        1. 公众号消息会话
            * 群发消息：订阅号为每天1次，服务号为每月4次，向用户群发消息，包括文字消息、图文消息、图片、视频、语音等
            * 被动回复消息：用户给公众号发消息后，可以回复一个消息
            * 客服消息：用户给公众号发消息后的48小时内，公众号可以给用户发送不限数量的消息
            * 模板消息：对用户发送服务通知（如刷卡提醒、服务预约成功通知等）时，公众号可以用特定内容模板，主动向用户发送消息
        2. 公众号内网页
            * 网页授权获取用户基本信息
            * 微信JS-SDK:可以使用它在网页上录制和播放微信语音、监听微信分享、上传手机本地图片、拍照等许多能力

    6. 样例

        ```html
        <!DOCTYPE html>
        <html lang="en">
            <head>
                <title>弹窗</title>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
                <meta http-equiv="X-UA-Compatible" content="ie=edge">
                <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
                <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
                <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>

                <style type="text/css">
                    .toast {
                        padding: 10px 25px 10px 25px;
                        background: rgba(0, 0, 0, .5);
                        border-radius: 5px;
                        color: #ffffff;
                        text-align: center;
                        position: fixed;
                        left: 50%;
                        top: 40%;
                        transform: translate(-50%, -50%);
                        z-index: 100;
                    }
                </style>
            </head>
            <body>
                <div id="test">
                    <toast v-if='isShow' :message='isShowMsg'></toast>
                    <div class="container" @click="showToast">
                        点击显示 showToast
                    </div>
                </div>
                <script>
                    var that;
                    Vue.component('toast', {
                        props: ['message'],
                        template: `
                        <div class="toast_bg_transparent">
                            <div class="toast">
                                <span>{{message}}</span>
                            </div>
                        </div>
                        `
                    })
                    new Vue({
                        el: '#test',
                        data() {
                            return {
                                isShow: false,
                                isShowMsg: '', //弹窗提示
                            }
                        },
                        methods: {
                            getA() {
                                var url = 'https://jayjing.wang/gongzhonghao_H5/getConfig.php';
                                $.ajax({
                                    url: url,
                                    complete: res => {
                                        var config = JSON.parse(res.responseText)
                                        console.log('res-config', config)
                                        wx.config({
                                            debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                                            appId: config.appId, // 必填，公众号的唯一标识
                                            timestamp: config.timestamp, // 必填，生成签名的时间戳
                                            nonceStr: config.nonceStr, // 必填，生成签名的随机串
                                            signature: config.signature, // 必填，签名
                                            jsApiList: [] // 必填，需要使用的JS接口列表
                                        });
                                    }
                                })
                            },
                            showToast() {
                                console.log('点击了 showToast')
                                this.isShow = true;
                                this.isShowMsg = '错误提示';

                                setTimeout(() => {
                                    this.isShow = false;
                                }, 1000);
                            }
                        },
                        mounted() {
                            this.getA()
                            wx.ready(function(res) {
                                console.log('ready', res)
                                // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
                            });
                        }
                    })
                </script>
            </body>
        </html>
        ```

        ```php
        <?php
            header("Content-Type:text/html;charset=utf8"); 
            header("Access-Control-Allow-Origin: *"); //解决跨域
            header('Access-Control-Allow-Methods:GET');// 响应类型  
            header('Access-Control-Allow-Headers:*'); // 响应头设置 
            $appid = "wx9025b8efd---";
            $secret = "3c242548fb56---";
                $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={$appid}&secret={$secret}";
                $s = file_get_contents($url);
                $s = json_decode($s, true);
                $url_b = "https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token={$s['access_token']}&type=jsapi";
                $data = file_get_contents($url_b);
                $data = json_decode($data, true);
                $ticket = $data['ticket'];
                //print();
                //echo $ticket;

                // 进行sha1签名
                $timestamp = time();
                $nonceStr = createNonceStr();
                // 注意 URL 建议动态获取(也可以写死).
                $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? "https://" : "http://";
                $url = "$protocol$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]"; // 调用JSSDK的页面地址
                //$url = $_SERVER['HTTP_REFERER']; // 前后端分离的, 获取请求地址(此值不准确时可以通过其他方式解决)
                $str = "jsapi_ticket={$ticket}&noncestr={$nonceStr}&timestamp={$timestamp}&url={$url}";
                $sha_str = sha1($str);
                $signPackage = array(
                    "appId" =>  $appid,
                    "nonceStr" => $nonceStr,
                    "timestamp" => $timestamp,
                    "signature" => $sha_str,
                );
                //echo $appid.'-----'.$nonceStr.'-----'.$timestamp.'-----'.$sha_str;
            echo urldecode(json_encode($signPackage));

            //随机字符串
            function createNonceStr($length = 16) {
                $chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                $str = "";
                for ($i = 0; $i < $length; $i++) {
                    $str .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);
                }
                return $str;
            }
            ?>
        ```

## 微信公众号开发配置

* 接入微信公众平台开发

    1. 填写服务器配置

        开发-基本设置-成为开发者-修改配置-填写：

        * 开发者用来接收微信消息和事件的接口URL
        * Token可由开发者可以任意填写，用作生成签名
        * EncodingAESKey由开发者手动填写或随机生成，将用作消息体加解密密钥
        * 可选择消息加解密方式：明文模式、兼容模式和安全模式

    2. 验证消息的确来自微信服务器

        开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上

        [校验代码](https://res.wx.qq.com/op_res/-serEQ6xSDVIjfoOHcX78T1JAYX-pM_fghzfiNYoD8uHVd3fOeC0PC_pvlg4-kmP)

    3. 依据接口文档实现业务逻辑

* 公众平台接口域名

    开发者可以根据自己的服务器部署情况，选择最佳的接入域名（延时更低，稳定性更高）。除此之外，可以将其他接入域名用作容灾用途。

    * 通用域名(api.weixin.qq.com)，使用该域名将访问官方指定就近的接入点；
    * 通用异地容灾域名(api2.weixin.qq.com)，当上述域名不可访问时可改访问此域名；
    * 上海域名(sh.api.weixin.qq.com)，使用该域名将访问上海的接入点；
    * 深圳域名(sz.api.weixin.qq.com)，使用该域名将访问深圳的接入点；
    * 香港域名(hk.api.weixin.qq.com)，使用该域名将访问香港的接入点。

* Access token

    access_token是公众号的全局唯一接口调用凭据，至少要保留512个字符空间，有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效

    公众号和小程序均可以使用AppID和AppSecret调用本接口来获取access_token

    * 调用：

        https请求方式: GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET

    * 说明：

        * 建议公众号开发者使用中控服务器统一获取和刷新access_token，不应该各自去刷新；

        * 中控服务器需要在2h提前去刷新新access_token，在刷新过程中，中控服务器可对外继续输出的老access_token，此时公众平台后台会保证在5分钟内，新老access_token都可用，这保证了第三方业务的平滑过渡；

        * access_token的有效时间可能会在未来有调整，所以中控服务器不仅需要内部定时主动刷新，还需要提供被动刷新access_token的接口，这样便于业务服务器在API调用获知access_token已超时的情况下，可以触发access_token的刷新流程

        * 对于可能存在风险的调用，需要用户管理员确认后才可以成功获取：

            * 开发者通过某IP发起调用->平台返回错误码[89503]并同时下发模板消息给公众号管理员->公众号管理员确认该IP可以调用->开发者使用该IP再次发起调用->调用成功
            * 如公众号管理员第一次拒绝该IP调用，用户在1个小时内将无法使用该IP再次发起调用
            * 公众号管理员多次拒绝该IP调用，该IP将可能长期无法发起调用
            * 建议开发者在发起调用前主动与管理员沟通确认调用需求，或请求管理员开启IP白名单功能并将该IP加入IP白名单列表

* 接口报警

    当微信服务器向开发者推送消息失败次数达到预定阈值时，会将报警消息发送到指定微信报警群中

    设置方式：公众平台->开发-运维中心->接口报警

    * 通用报警：
        * DNS失败

            * 填写的url,域名是否有误；
            
                * ping ip/域名

            * 域名是否发生变化，如过期，更新

        * DNS超时5秒

            * 目前不会有此错误

        * 连接超时5秒

            * 连接的IP是否有误

                * 获取到微信回调服务器的IP，https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=ACCESS_TOKEN
                * ping ip

            * 连接的IP是否过载，连接过多

                * 查看接入层服务器连接数，负载，nginx的配置，允许的连接个数
                * 查看nginx错误日志是否有“Connection reset by peer”或“Connection timed out”错误日志，如有说明nginx连接数过超负载。

                    一些重要配置参考例子
                    ```conf
                    worker_processes  16;          //CPU核数
                    error_log  logs/error.log  info;   //错误日志log
                    worker_rlimit_nofile 102400;     //打开最大句柄数
                    events {
                        worker_connections  102400;   //允许最大连接数
                    }
                    //请求日志记录，关键字段：request_time-请求总时间，upstream_response_time后端处理时 间
                    log_format  main  '$remote_addr  - $remote_user [$time_local] "$request" '
                                    '$status $body_bytes_sent "$http_referer" '
                                    '"$http_user_agent" "$http_x_forwarded_for" "$host"  "$cookie_ssl_edition" '
                                    '"$upstream_addr"   "$upstream_status"  "$request_time"  '
                                    '"$upstream_response_time" ';
                    access_log  logs/access.log  main;
                    ```

            * 托管商是否有故障
            * 网络运营商是否有故障
            * 是否设置了防火墙
            * 是否网络不通

        * 请求超时5秒

            * 连接的IP是否有误
            * 连接的IP是否接收到报警消息给出的该消息类型的请求
            * 请求是否处理时间过长
                * 机器负载太高，耗时增加
                    * 优化性能，扩容。
                    * 异步处理。
                * 机器处理异常，消息丢失
                

        * 回应不合法

            * 连接的IP是否有误
            * 连接的IP是否发生网络错误
            * 业务处理逻辑是否没有按照wiki规范回复消息，或是进入了异常逻辑

        * MarkFail（自动屏蔽，一分钟后解除屏蔽）

            此报警是级别最高的报警，开发者在收到此报警前，必然会收到连接超时，请求超时或回应失败等报警

    * 公众号第三方平台报警(公众号第三方平台的开发者，才需要关注)：
        * 推送component_verify_ticket超时5秒
        * 推送component_verify_ticket失败
        * 推送第三方平台消息超时5秒
        * 推送第三方平台消息失败

* 获取微信服务器IP地址

    1. 获取微信API接口 IP地址

        http请求方式: GET https://api.weixin.qq.com/cgi-bin/get_api_domain_ip?access_token=ACCESS_TOKEN

    2. 获取微信callback IP地址

        http请求方式: GET https://api.weixin.qq.com/cgi-bin/getcallbackip?access_token=ACCESS_TOKEN

    3. 网络检测

        HTTP Post请求： https://api.weixin.qq.com/cgi-bin/callback/check?access_token=ACCESS_TOKEN

## 菜单配置

* 概述

    1. 自定义菜单最多包括3个一级菜单，每个一级菜单最多包含5个二级菜单。
    2. 一级菜单最多4个汉字，二级菜单最多8个汉字，多出来的部分将会以“...”代替。
    3. 菜单的刷新策略：
        * 如果发现上一次拉取菜单的请求在5分钟以前，就会拉取一下菜单
        * 如果菜单有更新，就会刷新客户端的菜单
        * 测试时可以尝试取消关注公众账号后再次关注，则可以看到创建后的效果。​

* 按钮类型

    1. click：带上key值，推送event给开发者
    2. view：打开预设URL
    3. scancode_push：点击按钮后，调起扫一扫，把结果推送给开发者
    4. scancode_waitmsg：弹出“消息接收中”提示框用户点击按钮后，调起扫一扫，把结果推送给开发者
    5. pic_sysphoto：弹出系统拍照发图用户点击按钮后，调起相机，把图片发送给开发者
    6. pic_photo_or_album：弹出拍照或者相册发图用户点击按钮后，弹出选择器供用户选择“拍照”或者“从手机相册选择”
    7. pic_weixin：弹出微信相册发图器用户点击按钮后，调起微信相册，将选择的相片发送给开发者的服务器
    8. location_select：弹出地理位置选择器用户点击按钮后，调起地理位置选择工具，发送地理位置给开发者
    9. media_id：用户点击media_id类型按钮后，预设素材下发给用户（图片、音频、视频、图文消息），永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。
    10. view_limited：点击view_limited类型按钮后，打开素材对应URL，素材类型只支持图文消息

    3到8的所有事件，仅支持微信iPhone5.4.1以上版本，和Android5.4以上版本的微信用户

    9和10，是专门给资质认证未通过的订阅号准备的事件类型

* 相关接口

    1. 创建菜单POST：https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN
    2. 查询GET：https://api.weixin.qq.com/cgi-bin/get_current_selfmenu_info?access_token=ACCESS_TOKEN
    3. 删除GET：https://api.weixin.qq.com/cgi-bin/menu/delete?access_token=ACCESS_TOKEN
    4. 事件推送：
        1. 点击菜单拉取消息时的事件推送
        2. 点击菜单跳转链接时的事件推送
        3. scancode_push：扫码推事件的事件推送
        4. scancode_waitmsg：扫码推事件且弹出“消息接收中”提示框的事件推送
        5. pic_sysphoto：弹出系统拍照发图的事件推送
        6. pic_photo_or_album：弹出拍照或者相册发图的事件推送
        7. pic_weixin：弹出微信相册发图器的事件推送
        8. location_select：弹出地理位置选择器的事件推送
        9. 点击菜单跳转小程序的事件推送
    5. 个性化菜单：
        1. 创建个性化菜单
        2. 删除个性化菜单
        3. 测试个性化菜单匹配结果
        4. 查询个性化菜单
        5. 删除所有菜单

        * 开发者可以通过以下条件来设置用户看到的菜单：
            * 用户标签（开发者的业务需求可以借助用户标签来完成）
            * 性别
            * 手机操作系统
            * 地区（用户在微信客户端设置的地区）
            * 语言（用户在微信客户端设置的语言）

        * 说明：
            * 要求iPhone6.2.2，Android 6.2.4以上
            * 普通公众号新增接口每日限制2000次，删除接口2000次，测试个性化菜单匹配结果接口20000次
            * 一个公众号的所有个性化菜单，最多只能设置为跳转到3个域名下的链接
            * 创建个性化菜单之前必须先创建默认菜单，如果删除默认菜单，个性化菜单也会全部删除
            * 个性化菜单接口支持用户标签，当用户身上的标签超过1个时，以最后打上的标签为匹配

## 基础消息

* 普通消息

    当普通微信用户向公众账号发消息时，微信服务器将POST消息的XML数据包到开发者填写的URL上。

    * 注意：
        * 推荐使用msgid排重。
        * 微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次。假如服务器无法保证在五秒内处理并回复，可以直接回复空串
        * 如果需要对用户消息在5秒内立即做出回应，使用“发送消息-被动回复消息”接口向用户被动回复消息时，可以在开发者中心处设置消息加密。

    * 消息类型
        * 文本
        * 图片
        * 语音
        * 视频
        * 小视频
        * 地理位置
        * 链接

* 接收事件推送

    用户的某些操作会使得微信服务器通过事件推送的形式通知到开发者在开发者中心处设置的服务器地址

    1. 关注/取消关注事件

        为保护用户数据隐私，开发者收到用户取消关注事件时需要删除该用户的所有信息

        推荐使用FromUserName + CreateTime 排重

        服务器无法保证在五秒内处理并回复，可以直接回复空串

    2. 扫描带参数二维码事件

        如果用户还未关注公众号，则用户可以关注公众号，关注后微信会将带场景值关注事件推送给开发者。

        如果用户已经关注公众号，则微信会将带场景值扫描事件推送给开发者。

    3. 上报地理位置事件

        用户同意上报地理位置后，每次进入公众号会话时，都会在进入时上报地理位置，或在进入会话后每5秒上报一次地理位置，公众号可以在公众平台网站中修改以上设置。

    4. 自定义菜单事件

        用户点击自定义菜单后，微信会把点击事件推送给开发者，点击菜单弹出子菜单，不会产生上报。

    5. 点击菜单拉取消息时的事件推送

    6. 点击菜单跳转链接时的事件推送

* 被动回复用户消息

    当用户发送消息给公众号时，会产生一个POST请求，开发者可以在响应包（Get）中返回特定XML结构，来对该消息进行响应（现支持回复文本、图片、图文、语音、视频、音乐）。

    推荐使用FromUserName + CreateTime 排重

    同上有五秒机制

    如果开发者希望增强安全性，可以在开发者中心处开启消息加密

    一旦遇到以下情况，微信都会在公众号会话中，向用户下发系统提示“该公众号暂时无法提供服务，请稍后再试”：

    * 开发者在5秒内未回复任何内容
    * 开发者回复了异常数据，比如JSON数据等

    可回复消息类型：
    * 文本
    * 图片
    * 语音
    * 视频
    * 音乐
    * 图文

* 模板消息

    仅用于公众号向用户发送重要的服务通知，如信用卡刷卡通知，商品购买成功通知等。不支持广告等营销类消息以及其它所有可能对用户造成骚扰的消息。

    * 使用规则

        1. 认证后的服务号->功能->添加功能插件处->申请模板消息
        2. 需要选择公众账号服务所处的2个行业，每月可更改1次所选行业
        3. 在所选择行业的模板库中选用已有的模板进行调用
        4. 每个账号可以同时使用25个模板
        5. 每个账号的模板消息的日调用上限为10万次，当账号粉丝数超过10W/100W/1000W时，模板消息的日调用上限会相应提升，以公众号MP后台开发者中心页面中标明的数字为准。

    * 接口文档

        1. 模板消息调用时主要需要模板ID和模板中各参数的赋值内容
        2. 模板中参数内容必须以".DATA"结尾，否则视为保留字
        3. 模板保留符号""

    * 可调用接口

        1. 设置所属行业
        2. 获取设置的行业信息
        3. 获得模板ID
        4. 获取模板列表
        5. 删除模板
        6. 发送模板消息
        7. 事件推送

    * 运营规范

        * 允许发的模板消息

            1. 服务即时通知类消息模板

                资料变更类通知、政务服务即时类通知、物品（包含虚拟类）收取类通知、消费交易类通知、签到类通知、状态类通知、登录提醒类通知等一些用户触发后的即时通知。

            2. 服务后未即时通知类消息模板

                * 每月推送频率固定的模板消息

                    经过用户同意,发话费通知，水电费通知，物业费通知等

                * 推送频率不固定的模板消息

                    除故障类、灾害警示警告类允许特殊情况主动下发

                    经过用户同意,发到期提醒类通知、缴费提醒类通知、会议提醒类通知、赛事提醒类通知、发车提醒类通知、航班延误提醒类通知、待办任务提醒类通知等

                * 一般延时性通知

                    审核结果类通知、退款结果类通知、投标结果类通知、订单受理结果类通知、报名结果类通知、反馈类通知等

        * 不允许发的模板消息

            1. 模板内容与服务场景（含标题、关键词）不一致的模板

            2. 涉嫌广告营销类消息模板

                消费优惠类通知、购物返利类通知、商品降价类通知、商品更新提醒类通知等

            3. 发送频率过高，有骚扰用户倾向类消息模板

                一经发现频率过高骚扰到用户，或收到用户投诉，将会严厉惩处，轻则封接口处理，重则封号处理。

            4. 涉及红包、卡券、优惠券、代金券、会员卡、积分类消息模板

        * 模板审核标准

            1. 属于允许发的模板
            2. 格式正确
            3. 内容

                * 标题、关键词带有品牌或公司名等没有行业通用性的内容，不能通过，包括但不限于：某某公司服务通知、某某商品购买通知
                * 标题不能带标点或其它特殊符号，且必须以“通知”或“提醒”结尾，否则不能通过 包括不限于：领取红包！、天气提醒！
                * 易被用作群发，标题或关键词不能简要说明具体服务行为或使用场景的模板不能通过，包括但不限于：管理员类通知、公告类通知、系统通知
                * 易对用户骚扰的，发送频率较高的模板不能通过，包括但不限于 ：更新类通知、回复类通知、互动类通知
                * 推广宣传、营销类的模板不能通过，包括但不限于 ：红包类通知、优惠券类通知、活动类通知、积分类通知、奖励类通知
                * 模板库里已存在类似的模板不通过
            4. 模板内容长度不能超过200个字符，且必须有至少10个固定文字或标点
            5. 模版内容中，参数是可以在发送时赋值的，参数必须以“{ {”开头，以“.DATA} }”结尾）
            6. 严格按模板填写
            7. 可以通过增加“\n”，来实现换行
            8. 模版内容中，第一句话需要为礼貌性、称谓性的用语，这句话统一用{ {first.DATA} }参数来概括
            9. 模版内容的中部必须为2到5个“关键词名称：关键词内容参数”（中文冒号）的组合排列
            10. 模版内容中，末尾必须有{ {remark.DATA} }参数
            11. 直接相连在一起的参数，应简化为一个
            12. 模板标题和模板内容中，不允许带有品牌等关键词

        * 处罚规则

            对于多次使用同一模板违规的，将回收违规模板，不允许再使用，违规处罚将通过微信公众平台站内信告知运营者。

            1. 主动下发给没有接受过服务的接收者（故障报警、灾害报警和不涉及营销推广的通知除外）
            2. 模板消息的发送频率太高
            3. 营销、推广、诱导分享及诱导下载APP
            4. 模板内容与模板标题或关键词无关联 
            5. 模板内容是营销性质的群发活动公告通知

* 公众号一次性订阅消息

    开发者可以授权让微信用户授权第三方移动应用或公众号，获得发送一次订阅消息给到授权微信用户的机会。授权微信用户可以不需要关注公众号。微信用户每授权一次，开发者可获得一次下发消息的权限。

    对于已关注公众号的，消息将下发到公众号会话里；未关注公众号的，将下发到服务通知。

    * 公众号或网页使用一次性订阅消息流程:

        1. 需要用户同意授权，获取一次给用户推送一条订阅模板消息的机会
        2. 通过API推送订阅模板消息给到授权微信用户

* 群发接口和原创校验

    订阅号每天一条群发，服务号每月4条群发，某些具备开发能力的公众号运营者，可以通过高级群发接口，实现更灵活的群发能力。

    * 注意

        * 使用高级群发接口的每日调用限制为100次，但是用户每月只能接收4条
        * 可以使用预览接口校对消息样式和排版
        * 群发过程中，微信后台会自动进行图文消息原创校验，请提前设置好相关参数(send_ignore等)
        * 开发者可以主动设置 clientmsgid 来避免重复推送
        * 群发接口每分钟限制请求60次，超过限制的请求会被拒绝
        * 图文消息正文中插入自己帐号和其他公众号已群发文章链接的能力
        * 对于已开启API群发保护的账号，群发全部用户时需要等待管理员进行确认，如管理员拒绝或30分钟内没有确认，该次群发失败。用户可通过“设置-安全中心-风险操作保护”中关闭API群发保护功能。

    * 群发图文消息的过程

        1. 预先将图文消息中需要用到的图片，使用上传图文消息内图片接口，上传成功并获得图片 URL；
        2. 上传图文消息素材，需要用到图片时，请使用上一步获取的图片 URL；
        3. 使用对用户标签的群发，或对 OpenID 列表的群发，将图文消息群发出去，群发时微信会进行原创校验，并返回群发操作结果；
        4. 在上述过程中，如果需要，还可以预览图文消息、查询群发状态，或删除已群发的消息等。

    * 群发图片、文本等其他消息类型的过程

        * 群发文本消息，则直接根据下面的接口说明进行群发即可；
        * 群发图片、视频等消息，则需要预先通过素材管理接口准备好 mediaID。

    * 关于群发时使用is_to_all为true使其进入公众号在微信客户端的历史消息列表：

        * 使用is_to_all为true且成功群发，会使得此次群发进入历史消息列表。
        * 为防止异常，认证订阅号在一天内，只能使用is_to_all为true进行群发一次，或者在公众平台官网群发（不管本次群发是对全体还是对某个分组）一次。以避免一天内有2条群发进入历史消息列表。
        * 服务号在一个月内，使用is_to_all为true群发的次数，加上公众平台官网群发（不管本次群发是对全体还是对某个分组）的次数，最多只能是4次。
        * 设置is_to_all为false时是可以多次群发的，但每个用户只会收到最多4条，且这些群发不会进入历史消息列表。
        
        本接口中所有使用到media_id的地方，现在都可以使用素材管理中的永久素材media_id了。
        
        但注意，使用同一个素材群发出去的链接是一样的，这意味着，删除某一次群发，会导致整个链接失效。

    * 接口

        1. 上传图文消息内的图片获取URL【订阅号与服务号认证后均可用】

            本接口所上传的图片不占用公众号的素材库中图片数量的5000个的限制。图片仅支持jpg/png格式，大小必须在1MB以下。

        2. 上传图文消息素材【订阅号与服务号认证后均可用】

            含跳转小程序说明

            * 原创校验流程
                * 未命中原创库中的文章，则可以群发
                * 命中原创库中的文章
                    * 允许转载该文章，则可以进行群发，会自动替换成原文的样式，且会自动将文章注明为转载并显示来源。

                        若希望修改原文内容或样式，或群发时不显示转载来源，可自行与原创公众号作者联系并获得授权之后再进行群发。

                    * 原创作者禁止转载该文章，则不能进行群发

                        若希望转载该篇文章，可自行与原创公众号作者联系并获得授权之后再进行群发。

        3. 根据标签进行群发【订阅号与服务号认证后均可用】

        4. 根据OpenID列表群发【订阅号不可用，服务号认证后可用】

        5. 删除群发【订阅号与服务号认证后均可用】

            群发之后，随时可以通过该接口删除群发。

            * 只有已经发送成功的消息才能删除
            * 删除消息是将消息的图文详情页失效，已经收到的用户，还是能在其本地看到消息卡片。
            * 删除群发消息只能删除图文消息和视频消息，其他类型的消息一经发送，无法删除。
            * 如果多次群发发送的是一个图文消息，那么删除其中一次群发，就会删除掉这个图文消息也，导致所有群发都失效

        6. 预览接口【订阅号与服务号认证后均可用】

            开发者可通过该接口发送消息给指定用户，在手机端查看消息的样式和排版。为了满足第三方平台开发者的需求，在保留对openID预览能力的同时，增加了对指定微信号发送预览的能力，但该能力每日调用次数有限制（100次）。

        7. 查询群发消息发送状态【订阅号与服务号认证后均可用】

        8. 事件推送群发结果

            若群发任务提交成功，则在群发任务结束时，会向开发者在公众平台填写的开发者URL（callback URL）推送事件

            群发任务彻底完成需要较长时间，将会在群发任务即将完成的时候，就推送群发结果，此时的推送人数数据将会与实际情形存在一定误差

        9. 使用 clientmsgid 参数，避免重复推送

            群发时，微信后台将对 24 小时内的群发记录进行检查，如果该 clientmsgid 已经存在一条群发记录，则会拒绝本次群发请求，返回已存在的群发msgid，开发者可以调用“查询群发消息发送状态”接口查看该条群发的状态。

        10. 控制群发速度

            获取群发速度

* 接口调用频次限制说明

    1. 由于指标计算方法或统计时间差异，实时调用量数据可能会出现误差，一般在1%以内。
    2. 每个帐号每月共10次清零操作机会，清零生效一次即用掉一次机会（10次包括了平台上的清零和调用接口API的清零）。
    3. 第三方帮助公众号调用时，实际上是在消耗公众号自身的quota。
    4. 每个有接口调用限额的接口都可以进行清零操作。

    公众号调用或第三方平台帮公众号调用对公众号的所有api调用（包括第三方帮其调用）次数进行清零：

    POST： https://api.weixin.qq.com/cgi-bin/clear_quota?access_token=ACCESS_TOKEN

* 获取公众号的自动回复规则

    1. 第三方平台开发者可以通过本接口，在旗下公众号将业务授权给你后，立即通过本接口检测公众号的自动回复配置。
    2. 本接口仅能获取公众号在公众平台官网的自动回复功能中设置的自动回复规则，若公众号自行开发实现自动回复，或通过第三方平台开发者来实现，则无法获取。
    3. 认证/未认证的服务号/订阅号，以及接口测试号，均拥有该接口权限。
    4. 本接口中返回的图片/语音/视频为临时素材（临时素材每次获取都不同，3天内有效，通过素材管理-获取临时素材接口来获取这些素材），本接口返回的图文消息为永久素材素材（通过素材管理-获取永久素材接口来获取这些素材）。

    GET: https://api.weixin.qq.com/cgi-bin/get_current_autoreply_info?access_token=ACCESS_TOKEN